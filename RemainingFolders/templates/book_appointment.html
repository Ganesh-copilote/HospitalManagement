<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - FamilyCare Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-header { background: linear-gradient(90deg, #0077b6, #0096c7); color: white; }
        .form-label { font-weight: bold; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Book Appointment</h5>
                    </div>
                    <div class="card-body">
                        {% if error %}
                        <div class="alert alert-danger" role="alert">
                            {{ error }}
                        </div>
                        {% elif success %}
                        <div class="alert alert-success" role="alert">
                            {{ success }}
                        </div>
                        {% endif %}
                        <form method="POST" action="">
                            <div class="mb-3">
                                <label for="member_id" class="form-label">Select Patient</label>
                                <select class="form-select" id="member_id" name="member_id" required>
                                    <option value="">Select a patient</option>
                                    {% for member in members %}
                                    <option value="{{ member.id }}" {{ member_id == member.id|string|default('')|string == member.id|string|default('')|string and 'selected' }}>
                                        {{ member.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="doctor_id" class="form-label">Select Doctor</label>
                                <select class="form-select" id="doctor_id" name="doctor_id" required onchange="fetchSlots()">
                                    <option value="">Select a doctor</option>
                                    {% for doctor in doctors %}
                                    <option value="{{ doctor.id }}" {{ doctor_id == doctor.id|string|default('')|string == doctor.id|string|default('')|string and 'selected' }}>
                                        {{ doctor.name }} ({{ doctor.specialty }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="date" class="form-label">Select Date</label>
                                <input type="date" class="form-control" id="date" name="date" value="{{ date|default('') }}" required onchange="fetchSlots()">
                            </div>
                            <div class="mb-3">
                                <label for="slot_id" class="form-label">Select Time Slot</label>
                                <select class="form-select" id="slot_id" name="slot_id" required>
                                    <option value="">Select a time slot</option>
                                    {% for slot in available_slots %}
                                    <option value="{{ slot.id }}">{{ slot.slot_time }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <input type="hidden" name="appointment_id" value="{{ appointment_id|default('') }}">
                            <button type="submit" class="btn btn-primary">Book Appointment</button>
                            {% if current_appointment %}
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='/patient_dashboard#appointments'">Cancel Reschedule</button>
                            {% endif %}
                        </form>
                    </div>
                    <div class="card-footer text-muted">
                        <small>Current Date and Time: {{ current_time }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function fetchSlots() {
            const doctorId = document.getElementById('doctor_id').value;
            const date = document.getElementById('date').value;
            if (doctorId && date) {
                fetch(`/api/available_slots?doctor_id=${doctorId}&date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        const slotSelect = document.getElementById('slot_id');
                        slotSelect.innerHTML = '<option value="">Select a time slot</option>';
                        data.forEach(slot => {
                            const option = document.createElement('option');
                            option.value = slot.id;
                            option.textContent = slot.slot_time;
                            slotSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching slots:', error));
            }
        }

        // Trigger slot fetch on page load if doctor and date are preselected
        window.addEventListener('load', () => {
            if (document.getElementById('doctor_id').value && document.getElementById('date').value) {
                fetchSlots();
            }
        });
    </script>
</body>
</html>